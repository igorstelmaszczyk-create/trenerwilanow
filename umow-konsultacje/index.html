<script>
  // Ustawienia strony (focus header jak było)
  (function(){
    var contact = document.getElementById('contact-page');
    var header  = document.getElementById('site-header');
    if(contact&&header){ document.documentElement.classList.add('focus-header'); header.classList.add('header--focus'); }
  })();

  // PROSTY FORMULARZ
  document.addEventListener('DOMContentLoaded', () => {
    const $ = s => document.querySelector(s);
    const form = $('#contact-form');
    if(!form) return;

    const statusEl   = $('#cf-status');
    const btnSubmit  = form.querySelector('button[type="submit"]');
    const waLink     = $('#wa-dynamic');
    const consent    = $('#cf-consent');

    const inpName    = $('#cf-name');
    const chTel      = $('#ch-tel');
    const chMail     = $('#ch-mail');

    const wrapPhone  = $('#wrap-phone');
    const wrapEmail  = $('#wrap-email');
    const inpPhone   = $('#cf-phone');
    const inpEmail   = $('#cf-email');

    const hiddenPhone= $('#cf-phone-hidden');
    const hiddenEmail= $('#cf-email-hidden');
    const errContact = $('#err-contact');
    const replyTo    = $('#cf-replyto');

    const THANK_YOU_URL='https://trenerwilanow.pl/dziekujemy';

    // Źródło + UTM
    (function setMeta(){
      $('#cf-source').value = location.origin + location.pathname;
      const p=new URLSearchParams(location.search);
      const utm=['utm_source','utm_medium','utm_campaign','utm_term','utm_content']
        .map(k=>p.get(k)?k+'='+p.get(k):null).filter(Boolean).join('&');
      $('#cf-utm').value = utm;
    })();

    // Proste formatowanie PL telefonu 9 cyfr (+48 obsługiwane)
    function formatPL(raw){
      const d = raw.replace(/[^\d+]/g,'');
      const noCC = d.replace(/^(\+?48)/,''); // usuń +48
      const digits = noCC.replace(/\D/g,'').slice(0,9);
      return digits.replace(/(\d{3})(\d{3})(\d{0,3})/,(m,a,b,c)=> c ? `${a} ${b} ${c}` : (b ? `${a} ${b}` : a));
    }
    function isValidPhone(v){
      const digits = v.replace(/\D/g,'');
      return digits.length >= 6; // miękko: 6+ cyfr
    }
    function isValidEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v);
    }

    // Przełączanie kanału — pokazuj tylko odpowiednie pole
    function syncChannelUI(){
      const tel = chTel.checked;
      wrapPhone.hidden = !tel;
      wrapEmail.hidden = tel;
      // dostępność
      inpPhone.toggleAttribute('required', tel);
      inpEmail.toggleAttribute('required', !tel);
      // WA jako skrót bardziej sensowny przy telefonie
      waLink.style.display = tel ? 'inline-flex' : 'none';
      // wyczyść błędy
      errContact.hidden = true;
      inpPhone.setAttribute('aria-invalid','false');
      inpEmail.setAttribute('aria-invalid','false');
    }
    chTel.addEventListener('change', syncChannelUI);
    chMail.addEventListener('change', syncChannelUI);
    syncChannelUI();

    // Auto-format telefonu i aktualizacja ukrytych mirrorów
    inpPhone.addEventListener('input', ()=>{
      const caret = inpPhone.selectionStart;
      inpPhone.value = formatPL(inpPhone.value);
      hiddenPhone.value = inpPhone.value.replace(/\D/g,'');
      buildWhatsApp();
      // nie modyfikujemy caret — przy takim prostym formatterze jest OK
    });
    inpEmail.addEventListener('input', ()=>{
      hiddenEmail.value = inpEmail.value.trim();
      replyTo.value = hiddenEmail.value;
      buildWhatsApp();
    });
    inpName.addEventListener('input', buildWhatsApp);
    document.querySelectorAll('input[name="goal"],#cf-msg').forEach(el=>el.addEventListener('input', buildWhatsApp));

    // Komunikat WhatsApp
    function buildWhatsApp(){
      const name = (inpName.value||'').trim();
      const goal = (form.querySelector('input[name="goal"]:checked')?.value||'').trim();
      const msg  = ($('#cf-msg').value||'').trim();
      const phone= hiddenPhone.value;
      const email= hiddenEmail.value;

      const parts = [
        "Cześć Igor, chcę umówić bezpłatną konsultację w Zdrofit Wilanów.",
        name && `Imię: ${name}`,
        goal && goal!=='Inny' && `Cel: ${goal}`,
        msg  && `Wiadomość: ${msg}`,
        phone && `Tel: ${phone}`,
        email && `Email: ${email}`
      ].filter(Boolean).join('\n');

      waLink.href = `https://wa.me/48537918161?text=${encodeURIComponent(parts)}`;
    }
    buildWhatsApp();

    // Anty-spam: 2.5 s na stronie + honeypot puste
    const pageReadyTs = Date.now();
    function passAntiSpam(){
      const honey = form.querySelector('input[name="_honey"]')?.value||'';
      const waited = (Date.now()-pageReadyTs) >= 2500;
      return !honey && waited;
    }

    // Walidacja
    function validate(){
      let ok = true;
      if(!inpName.value.trim()) ok = false;

      if(chTel.checked){
        const v = inpPhone.value;
        const valid = isValidPhone(v);
        inpPhone.setAttribute('aria-invalid', String(!valid));
        errContact.hidden = valid;
        ok = ok && valid;
        hiddenEmail.value = ''; // czyść drugi kanał
        replyTo.value     = '';  // brak e-maila do reply-to
      }else{
        const v = inpEmail.value.trim();
        const valid = isValidEmail(v);
        inpEmail.setAttribute('aria-invalid', String(!valid));
        errContact.hidden = valid;
        ok = ok && valid;
        hiddenPhone.value = ''; // czyść telefon gdy e-mail
      }

      if(!consent.checked) ok = false;
      return ok;
    }

    // Submit
    async function fetchWithTimeout(resource,options={},timeout=10000){
      const ctrl=new AbortController();
      const id=setTimeout(()=>ctrl.abort(), timeout);
      try{ return await fetch(resource,{...options,signal:ctrl.signal}); }
      finally{ clearTimeout(id); }
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent = '';
      if(!validate()){
        statusEl.textContent = 'Uzupełnij wymagane pola.';
        statusEl.style.color = '#c0392b';
        (chTel.checked ? inpPhone : inpEmail).focus();
        return;
      }
      if(!passAntiSpam()){
        statusEl.textContent = 'Zbyt szybkie wysłanie — spróbuj ponownie.';
        statusEl.style.color = '#c0392b';
        return;
      }

      // Ustaw pola hidden pod piękną tabelkę w mailu
      const fd = new FormData(form);
      if(chTel.checked){
        fd.set('phone', hiddenPhone.value);
        fd.delete('email');
      }else{
        fd.set('email', hiddenEmail.value);
        fd.delete('phone');
      }
      // reply-to tylko jeśli mamy e-mail
      replyTo.value = hiddenEmail.value || '';

      // Stan ładowania
      btnSubmit.disabled = true;
      btnSubmit.setAttribute('aria-busy','true');
      const oldText = btnSubmit.textContent;
      btnSubmit.textContent = 'Wysyłam…';
      statusEl.textContent = 'Wysyłam…';
      statusEl.style.color = '#666';

      try{
        const res = await fetchWithTimeout('https://formsubmit.co/ajax/igorstelmaszczyk@gmail.com',
          { method:'POST', body:fd, headers:{'Accept':'application/json'} }, 10000);
        const json = await res.json();
        if(json.success==='true' || json.message){ location.assign(THANK_YOU_URL); return; }
        throw new Error('Błąd wysyłki');
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Ups, coś poszło nie tak. Napisz proszę na WhatsApp lub zadzwoń.';
        statusEl.style.color = '#c0392b';
      }finally{
        btnSubmit.disabled = false;
        btnSubmit.removeAttribute('aria-busy');
        btnSubmit.textContent = oldText;
      }
    });
  });
</script>
